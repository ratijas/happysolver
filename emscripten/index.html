<!doctype html>
<html><head>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2231125-5', 'auto');
  ga('send', 'pageview');
</script>
<script id="stdpcs" src="j_stdpcs.xml"></script>  

<script id="unimesh2" src="unified_mesh.js"></script>  

<script id="one_cube" src="j_one_piece_cube.txt"></script>    
<script id="one_cube" src="j_one_marble_cube.txt"></script>    

<script type="text/javascript">

// unified_mesh.js
// j_unified_meshes_all.txt
    
var gl = null, canvas = null
var prog = null
var model = { vtxBuf: null }

var loadSolution, resize, mouseUp, mouseDown, mouseMove, mouseDblClick, mouseWheel, cpp_draw, cpp_slvrun, getTms
var ctrlPressed = false;
    
function start() {

    Module.ccall('cpp_start', null);
    
    Module.ccall('initCubeEngine', 'boolean', ['string', 'number'], [stdpcs_text, 0])

    loadSolution = Module.cwrap('loadSolution', null, ['string'])
    resize = Module.cwrap('resize', null, ['number', 'number'])
    mouseDown = Module.cwrap('mouseDown', null, ['number', 'number', 'number'])
    mouseUp = Module.cwrap('mouseUp', null, ['number'])
    mouseMove = Module.cwrap('mouseMove', null, ['number', 'number', 'number', 'number'])
    mouseDblClick = Module.cwrap('mouseDblClick', null, ['number', 'number', 'number'])
    mouseWheel = Module.cwrap('mouseWheel', null, ['number'])
    cpp_draw = Module.cwrap('cpp_draw', 'boolean', [])
    cpp_slvrun = Module.cwrap('cpp_slvrun', 'boolean', [])
    getTms = Module.cwrap('getTms', 'number', [])
    solveGo = Module.cwrap('solveGo', null, [])
    
    //loadSolution(one_piece_cube_text)
    //loadSolution(one_marble_cube_text)
    solveGo()
    
    resize(mycanvas.width, mycanvas.height)
    
    mycanvas.onmousedown = handleMouseDown;
    document.onmouseup = handleMouseUp;
    document.onmousemove = handleMouseMove;
    mycanvas.ondblclick = handleMouseDblClick;
    mycanvas.onwheel = handleMouseWheel
    
    document.onkeydown = document.onkeyup = handleKey  

    // start drawing
    requestAnimationFrame(animProgress)
    setInterval(sampleTms, 1000)
}

function handleMouseDown(event) {
    mouseDown( (event.button == 2)?1:0, event.clientX, event.clientY)
}
function handleMouseUp(event) {
    mouseUp( (event.button == 2)?1:0)
}
function handleMouseMove(event) {
    mouseMove(event.buttons, ctrlPressed?1:0, event.clientX, event.clientY)
}
function handleMouseDblClick(event) {
    mouseDblClick(ctrlPressed?1:0, event.clientX, event.clientY);
}
function handleMouseWheel(event) {
    mouseWheel(-event.deltaY / 16)
}

function handleKey(event) {
    ctrlPressed = event.ctrlKey;
    mouseMove(0, ctrlPressed?1:0, -1, -1)
}

function registerTexBind(imgname, obj) {
    console.log("reg-tex " + imgname)
    //var img = new Image()
    //img.onload = function() {
        _glBindTexture(GLctx.TEXTURE_2D, obj)
        GLctx.texImage2D(GLctx.TEXTURE_2D, 0, GLctx.RGBA, GLctx.RGBA, GLctx.UNSIGNED_BYTE, noisetex)
    //}
    //img.src = 'cubeTex.jpg'
}

function requestAnim() {
    requestAnimationFrame(animProgress)
}

function animProgress() {
    var again = cpp_draw();
    if (again)
        requestAnimationFrame(animProgress)
    
}

var enterSlv = false

function requestSlvRun() {
    setTimeout(slvRun, 0)
    enterSlv = true
}



function slvRun() {
    if (!enterSlv)
        return
    setTimeout(slvRun, 0)  // pre-schedule the next time to avoid delay
    enterSlv = cpp_slvrun()
    //if (again)
    //    setTimeout(slvRun, 0)
    
}

var lastTms = 0
function sampleTms() {
    var tms = getTms()
    var delta = tms - lastTms
    if (delta != 0)
        stat.innerHTML = "" + delta
    lastTms = tms
}

</script>

<script src="js_main.js"></script>
</head>
<body onload="start();">
    <canvas id="mycanvas" width="800" height="700"></canvas>
    <img id="noisetex" src='cubeTex.png' style="display:none;"/>
    <div id="stat"></div>
</body>
</html>
