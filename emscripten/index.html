<!doctype html>
<html><head>
<!--<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2231125-5', 'auto');
  ga('send', 'pageview');
</script> -->


<script id="stdpcs" src="stdpcs.js"></script>  
<script id="unimesh2" src="unified_mesh.js"></script>  
<script id="one_cube" src="one_piece_cube.js"></script>    
<script id="one_cube" src="one_marble_cube.js"></script>    


<script type="text/javascript">

// unified_mesh.js
// j_unified_meshes_all.txt
    
var gl = null, canvas = null
var prog = null
var model = { vtxBuf: null }

var loadSolution, resize, mouseUp, mouseDown, mouseMove, mouseDblClick, mouseWheel, cpp_draw, cpp_slvrun, getTms
var ctrlPressed = false;
    
function start() {

    picsAddFamily("Happy Cube", "hc")
    picsAddCube("Blue", "hc_blue")
    picsAddCube("Red", "hc_red")
    picsAddCube("Purple", "hc_purple")
    picsAddFamily("Profi Cube", "pc")
    picsAddCube("AAAA", "pc_aaa")
    picsAddCube("BBBB", "pc_bbbb")
    //return

    Module.ccall('cpp_start', null);
    
    Module.ccall('initCubeEngine', 'boolean', ['string', 'number'], [stdpcs_text, 0])

    loadSolution = Module.cwrap('loadSolution', null, ['string'])
    resize = Module.cwrap('resize', null, ['number', 'number'])
    mouseDown = Module.cwrap('mouseDown', null, ['number', 'number', 'number'])
    mouseUp = Module.cwrap('mouseUp', null, ['number'])
    mouseMove = Module.cwrap('mouseMove', null, ['number', 'number', 'number', 'number'])
    mouseDblClick = Module.cwrap('mouseDblClick', null, ['number', 'number', 'number'])
    mouseWheel = Module.cwrap('mouseWheel', null, ['number'])
    cpp_draw = Module.cwrap('cpp_draw', 'boolean', [])
    cpp_slvrun = Module.cwrap('cpp_slvrun', 'boolean', [])
    getTms = Module.cwrap('getTms', 'number', [])
    solveGo = Module.cwrap('solveGo', null, [])
    
    loadSolution(one_piece_cube_text)
    //loadSolution(one_marble_cube_text)
    //solveGo()
    
    resize(mycanvas.width, mycanvas.height)
    
    mycanvas.onmousedown = handleMouseDown;
    document.onmouseup = handleMouseUp;
    document.onmousemove = handleMouseMove;
    mycanvas.ondblclick = handleMouseDblClick;
    mycanvas.onwheel = handleMouseWheel
    
    document.onkeydown = document.onkeyup = handleKey  

    // start drawing
    requestAnimationFrame(animProgress)
    setInterval(sampleTms, 1000)
    

}

function handleMouseDown(event) {
    mouseDown( (event.button == 2)?1:0, event.clientX, event.clientY)
}
function handleMouseUp(event) {
    mouseUp( (event.button == 2)?1:0)
}
function handleMouseMove(event) {
    mouseMove(event.buttons, ctrlPressed?1:0, event.clientX, event.clientY)
}
function handleMouseDblClick(event) {
    mouseDblClick(ctrlPressed?1:0, event.clientX, event.clientY);
}
function handleMouseWheel(event) {
    mouseWheel(-event.deltaY / 16)
}
function handleKey(event) {
    ctrlPressed = event.ctrlKey;
    mouseMove(0, ctrlPressed?1:0, -1, -1)
}

var lastFamAdded = ''

function picsAddFamily(famName, id) {
    var picsCtrl = '<div id="' + id + '_frame" class="toppic">' + famName + '\
    <img class="toppic_icon" id="' +  id + '_img" src="arrow_up.png" onclick="pic_rolldown('+ id + '_frame, this)"/> \
    </div>'
    side_rel.innerHTML += picsCtrl
    lastFamAdded = id
}
function picsAddCube(cubeName, id) {
    var txt = '<div id="' + id + '_inframe" class="' + lastFamAdded + 'piccube">' + cubeName + '</div>'
    document.getElementById(lastFamAdded + "_frame").innerHTML += txt
}

function registerTexBind(imgname, obj) {
    console.log("reg-tex " + imgname)
    //var img = new Image()
    //img.onload = function() {
        _glBindTexture(GLctx.TEXTURE_2D, obj)
        GLctx.texImage2D(GLctx.TEXTURE_2D, 0, GLctx.RGBA, GLctx.RGBA, GLctx.UNSIGNED_BYTE, noisetex)
    //}
    //img.src = 'cubeTex.jpg'
}

function requestAnim() {
    requestAnimationFrame(animProgress)
}

function animProgress() {
    var again = cpp_draw();
    if (again)
        requestAnimationFrame(animProgress)
    
}

var enterSlv = false

function requestSlvRun() {
    setTimeout(slvRun, 0)
    enterSlv = true
}



function slvRun() {
    if (!enterSlv)
        return
    setTimeout(slvRun, 0)  // pre-schedule the next time to avoid delay
    enterSlv = cpp_slvrun()
    //if (again)
    //    setTimeout(slvRun, 0)
    
}

var lastTms = 0
function sampleTms() {
    var tms = getTms()
    var delta = tms - lastTms
    if (delta != 0)
        stat.innerHTML = "" + delta
    lastTms = tms
}


function pic_rolldown(elem, elemImg) {
    if (elem.isDown) {
        elem.isDown = false
        elem.style.height = ""
        elemImg.src = "arrow_up.png"
    }
    else {
        elem.isDown = true
        elem.style.height = "200px"
        elemImg.src = "arrow_down.png"
    }
}


var testt = "adfadfd\
sdfsfdf"

</script>
<script src="js_main.js"></script>
<style>
#side_ctrl {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 200px;
    background: #cbcfff;
    margin-top: 8px;
    margin-bottom: 8px;
}
.toppic {
    margin: 5px;
    background: #eeeeff;
    font-family: Verdana;
    padding: 4px;
    border-radius: 5px;
}
.in_rel {
    position:relative; 
    width:100%; 
    height:100%;
}
.toppic_icon {
    float: right;

}
</style>
</head>
<body onload="start();">
    <div id="side_ctrl"><div id="side_rel" class="in_rel">

    </div></div>
    <canvas id="mycanvas" width="800" height="700"></canvas>
    <img id="noisetex" src='cubeTex.png' style="display:none;"/>
    <img src="arrow_up.png" style="display:none;"/>
    <img src="arrow_down.png" style="display:none;"/>
    <div id="stat"></div>
</body>
</html>
