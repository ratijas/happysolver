<!doctype html>
<html><head>

<script id="stdpcs" src="j_stdpcs.xml"></script>  

<script id="unimesh2" src="unified_mesh.js"></script>  

<script id="one_cube" src="j_one_piece_cube.txt"></script>    
<script id="one_cube" src="j_one_marble_cube.txt"></script>    

<script type="text/javascript">

// unified_mesh.js
// j_unified_meshes_all.txt
    
var gl = null, canvas = null
var prog = null
var model = { vtxBuf: null }

var loadSolution, resize, mouseUp, mouseDown, mouseMove, mouseDblClick, mouseWheel
    
function start() {

    Module.ccall('cpp_start', null);
    
    Module.ccall('initCubeEngine', 'boolean', ['string', 'number'], [stdpcs_text, 0])

    
    loadSolution = Module.cwrap('loadSolution', null, ['string'])
    resize = Module.cwrap('resize', null, ['number', 'number'])
    mouseDown = Module.cwrap('mouseDown', null, ['number', 'number', 'number'])
    mouseUp = Module.cwrap('mouseUp', null, ['number'])
    mouseMove = Module.cwrap('mouseMove', null, ['number', 'number', 'number', 'number'])
    mouseDblClick = Module.cwrap('mouseDblClick', null, ['number', 'number', 'number'])
    mouseWheel = Module.cwrap('mouseWheel', null, ['number'])
    
    //loadSolution(one_piece_cube_text)
    loadSolution(one_marble_cube_text)
    resize(mycanvas.width, mycanvas.height)
    
    mycanvas.onmousedown = handleMouseDown;
    document.onmouseup = handleMouseUp;
    document.onmousemove = handleMouseMove;
    mycanvas.ondblclick = handleMouseDblClick;
    mycanvas.onwheel = handleMouseWheel

    // start drawing
    requestAnimationFrame(progress)

}

function handleMouseDown(event) {
    mouseDown( (event.button == 2)?1:0, event.clientX, event.clientY)
}
function handleMouseUp(event) {
    mouseUp( (event.button == 2)?1:0)
}
function handleMouseMove(event) {
    mouseMove(event.buttons, 0, event.clientX, event.clientY)
}
function handleMouseDblClick(event) {
    mouseDblClick(0, event.clientX, event.clientY);
}
function handleMouseWheel(event) {
    mouseWheel(-event.deltaY / 16)
}

function registerTexBind(imgname, obj) {
    console.log("reg-tex " + imgname)
    //var img = new Image()
    //img.onload = function() {
        _glBindTexture(GLctx.TEXTURE_2D, obj)
        GLctx.texImage2D(GLctx.TEXTURE_2D, 0, GLctx.RGBA, GLctx.RGBA, GLctx.UNSIGNED_BYTE, noisetex)
    //}
    //img.src = 'cubeTex.jpg'
}

function requestProgress() {
    requestAnimationFrame(progress)
}

function progress() {

    var ok = Module.ccall('cpp_progress', 'boolean');
    if (!ok)
        return;
    
    // next frame
    //requestAnimationFrame(progress)
    //setTimeout(progress, 0)
}

</script>

<script src="js_main.js"></script>
</head>
<body onload="start();">
    <canvas id="mycanvas" width="800" height="700"></canvas>
    <img id="noisetex" src='cubeTex.png' style="display:none;"/>
</body>
</html>
